#!/bin/bash
# This does a test deploy of Swift
die () { local _res=$1; shift; echo "$@"; exit $_res; }

[[ $DEBUG ]] && set -x
set -e

crowbar swift proposal create cluster1
crowbar swift proposal show cluster1 >"$LOGDIR/swift-proposal.json"
crowbar swift proposal commit cluster1 || {
    echo "Swift proposal failed to commit"
    exit 1
}

crowbar swift show cluster1 > "$LOGDIR/swift-cluster1.json"
read proxy < <(sed -n '/"swift-proxy-acct": \[/ { n; p }' \
    "$LOGDIR/swift-cluster1.json")
proxy="${proxy//\"/}."
addr_re='Address: ([0-9.]+)'
if ! [[ $(nslookup "$proxy" "$CROWBAR_IP") =~ $addr_re ]]; then
    crowbar swift show cluster1 >"$LOGDIR/swift-failed.json"
    die 1 "Could not find IP address of the swift proxy ($proxy)"
fi
proxy_ip="${BASH_REMATCH[1]}"
crowbar swift show cluster1 >"$LOGDIR/swift-deployed.json"
echo "Swift proxy at $proxy_ip.  Prepping the Storage subsystem..."
while ! run_on "$proxy_ip" swauth-prep -K swauth -U .super_admin \
    -A 'https://127.0.0.1:8080/auth/'; do
    echo "Unable to prep the authentication subsystem, rebooting proxy node."
    echo "This is definitly a big in the way Swift is deployed."
    run_on $proxy_ip reboot
    sleep 120
done

echo "Creating an account..."
while ! run_on "$proxy_ip" swauth-add-account -K swauth -U .super_admin \
    -A https://127.0.0.1:8080/auth/ a_test; do
    echo "Unable to create an account, rebooting proxy node."
    echo "This is definitly a bug in the way Swift is being deployed."
    run_on "$proxy_ip" reboot
    sleep 120
done

echo "Creating a user..."
while ! run_on "$proxy_ip" swauth-add-user -K swauth -U .super_admin \
    -A https://127.0.0.1:8080/auth/ -a a_test test test; do
    echo "Unable to create a user, rebooting proxy node."
    echo "This is definitly a bug in the Swift deploy."
    run_on "$proxy_ip" reboot
    sleep 120
done

auth_hdr=$(mktemp "$LOGDIR/swift-auth-header-XXXXX.txt") || \
    die 1 "Could not make a temp location for the aithentication header."

# get the auth information we will need
while read line; do
    echo "$line" >>"$auth_hdr"
    hdr=${line%%:*}
    param=${line#*:}
    case $hdr in
	X-Storage-Url) storage_url=$param;;
	X-Storage-Token) storage_token=$param;;
	X-Auth-Token) auth_token=$param;;
    esac
done < <(curl -k -D - -H -o /dev/null "X-Auth-User: a_test:test" \
    -H "X-Auth-Key: test" --connect-timeout 30 --max-time 120 \
    https://$proxy_ip:8080/auth/v1.0/)
    
[[ $storage_url && $storage_token && $auth_token ]] || \
    die 1 "Could not get a necessary parameter from the Swift proxy!"

# $1 = http method
# $2 = pathname for swift
# $3 = local path (optional)
do_swift() {
    local curlargs=(-k -D - 
	-H "X-Auth-Token: $auth_token"
	-H "X-Auth-User: a_test:test"
	-X "$1"
	"$storage_url/$2")
    if [[ $3 && $1 = PUT ]]; then
	curlargs+=(-T "$3")
    elif [[ $3 && $1 = GET ]]; then
	curlargs+=(-o "$3")
    fi
    curl "${curlargs[@]}" || return 1
}

echo "Testing Swift functionality..."
do_swift PUT testdir || die 1 "Could not create a directory in Swift"
testfile=$(mktemp "$LOGDIR/swift-testfile-XXXXX")
outfile=$(mktemp "$LOGDIR/swift-outfile-XXXXX")
dd if=/dev/urandom "of=$testfile" bs=64K count=1
do_swift PUT testdir/testfile "$testfile" || \
    die 1 "Could not store random information into Swift"
do_swift GET testdir/testfile "$outfile" || \
    die 1 "Could not get our random data back from Swift"
echo "Swift deploy passed."
exit 0

